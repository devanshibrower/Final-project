<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>Lyre - Genre Treemap Visualization</title>
    <style>
        .node {
            stroke: #fff;
            cursor: pointer;
        }
        .label {
            font-size: 12px;
            text-anchor: middle;
        }
    </style>

</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Lyre</h1>
        </div>
        <div class="content">
            <div id="playlists">
                <h2>Playlists</h2>
                <ul>
                    {% for playlist in playlists %}
                        <li data-playlist-id="{{ playlist.id }}" class="{{ 'selected' if loop.first else '' }}">{{ playlist.name }}</li>
                    {% endfor %}
                </ul>
            </div>
            <div id="chart-container">
                <div id="chart"></div>
            </div>
        </div>
        
        <!-- Remove or comment out this section if it exists -->
        <!--
        <div id="song-list">
            <h2>Songs in Selected Genre</h2>
            <ul id="songs"></ul>
        </div>
        -->
        
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const playlistItems = document.querySelectorAll('#playlists li');
                
                function selectPlaylist(playlistItem) {
                    playlistItems.forEach(item => item.classList.remove('selected'));
                    playlistItem.classList.add('selected');
                    const playlistId = playlistItem.getAttribute('data-playlist-id');
                    fetchGenreCounts(playlistId);
                }

                playlistItems.forEach(item => {
                    item.addEventListener('click', function() {
                        selectPlaylist(this);
                    });
                });

                function fetchGenreCounts(playlistId) {
                    fetch(`/get_genre_counts/${playlistId}`)
                        .then(response => response.json())
                        .then(data => {
                            updateTreemap(data);
                        })
                        .catch(error => console.error('Error:', error));
                }

                function updateTreemap(genreCounts) {
                    console.log("Updating treemap with data:", genreCounts);
                    
                    // Clear existing chart
                    d3.select("#chart").selectAll("*").remove();

                    // Set up the D3 treemap container
                    const width = document.getElementById('chart').clientWidth;
                    const height = 600;

                    const data = {
                        name: "Genres",
                        children: Object.entries(genreCounts).map(([key, value]) => ({
                            name: key,
                            value: value
                        }))
                    };

                    const root = d3.hierarchy(data)
                        .sum(d => d.value)
                        .sort((a, b) => b.value - a.value);

                    const treemap = d3.treemap()
                        .size([width, height])
                        .padding(1);

                    treemap(root);

                    const svg = d3.select("#chart")
                        .append("svg")
                        .attr("width", width)
                        .attr("height", height);

                    const color = d3.scaleOrdinal(d3.schemeCategory10);

                    const nodes = svg.selectAll("g")
                        .data(root.leaves())
                        .enter()
                        .append("g")
                        .attr("transform", d => `translate(${d.x0},${d.y0})`);

                    nodes.append("rect")
                        .attr("width", d => d.x1 - d.x0)
                        .attr("height", d => d.y1 - d.y0)
                        .attr("fill", (d, i) => color(d.data.name));

                    nodes.append("text")
                        .attr("x", 3)
                        .attr("y", 15)
                        .text(d => d.data.name)
                        .attr("font-size", "12px")
                        .attr("fill", "white");
                }

                // Create initial treemap
                const initialGenreCounts = {{ genre_counts | tojson }};
                console.log("Initial genre counts:", initialGenreCounts);
                updateTreemap(initialGenreCounts);

                // Select the first playlist by default
                if (playlistItems.length > 0) {
                    selectPlaylist(playlistItems[0]);
                }
            });
        </script>
    </div>
</body>
</html>
